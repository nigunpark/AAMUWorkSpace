<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="aamu.mybatis.mapper.commu">

	<!-- 글 목록용 -->
	<select id="commuSelectList" resultType="commuDTO" parameterType="Map">
		SELECT c.*,cp.contentid,p.title FROM community c
		JOIN commuplace cp ON c.lno=cp.lno
		JOIN places p ON cp.contentid=p.contentid
		<if test="searchColumn != null">
  	 		WHERE ${searchColumn} LIKE '%'||#{searchWord}||'%' 
  	 	</if>
		ORDER BY c.lno DESC
	</select>
	
	<!-- 글 목록용_댓글 한개 뿌려주기 -->
	<select id="commuCommentSelectOne" parameterType="String" resultType="commuCommentDTO" >
		SELECT * FROM commucomment WHERE lno=#{lno} AND ROWNUM = 1
	</select>
	
	<!-- 글 목록용_사진 뿌려주기 -->
	<select id="commuSelectPhotoList" parameterType="String" resultType="String">
		SELECT photo FROM commuphoto WHERE lno=#{lno}
	</select>
	
	<!-- 글 생성용 -->
	<insert id="commuInsert" parameterType="Map">
		INSERT INTO community
		VALUES (SEQ_COM.NEXTVAL,#{id},#{title},#{content},TO_DATE(#{postdate},'YYYY-MM-DD'),DEFAULT,DEFAULT)
		<selectKey keyProperty="lno" resultType="int" order="AFTER">
	    	SELECT SEQ_COM.CURRVAL FROM DUAL
	    </selectKey>
	</insert>
	
	<!-- 글 생성용_사진 저장 -->
	<insert id="commuPhotoInsert" parameterType="Map" >
		INSERT INTO commuphoto VALUES (#{lno},#{photo})
	</insert>
	
	<!-- 글 생성용_장소 저장 -->
	<insert id="commuPlaceInsert" parameterType="Map" >
		INSERT INTO commuplace VALUES (#{lno},#{contentid})
	</insert>
	
	<!-- 글 생성용_장소 뿌려주기 -->
	<select id="commuPlaceList" resultType="Map" parameterType="Map">
		SELECT contentid, title, addr FROM places WHERE title LIKE '%'||#{searchWord}||'%' or addr LIKE '%'||#{searchWord}||'%'
	</select>
	
	<!-- 글 하나 뿌려주는 용-->
	<select id="commuSelectOne" resultType="commuDTO" parameterType="String">
		SELECT c.*,cp.contentid,p.title FROM community c JOIN commuplace cp ON c.lno=cp.lno JOIN places p ON cp.contentid=p.contentid WHERE c.lno=#{lno}
	</select>
	
	<!-- 글 하나 뿌려주는 용_모든 댓글 뿌려주기-->
	<select id="commuCommentList" parameterType="String" resultType="commuCommentDTO" >
		SELECT * FROM commucomment WHERE lno=#{lno}
	</select>
	
	<!-- 글 수정용 -->
	<update id="commuUpdate" parameterType="Map">
		UPDATE community SET ctitle=#{ctitle},content=#{content} WHERE lno=#{lno}
	</update>
	
	<!-- 글 수정용_commuplace 수정 -->
	<update id="commuPlaceUpdate" parameterType="Map">
		UPDATE commuplace SET contentid=#{contentid} WHERE lno=#{lno}
	</update>
	
	<!-- 글 삭제용 -->
	<delete id="commuDelete" parameterType="String">
		DELETE FROM community WHERE lno=#{lno}
	</delete>
	
	<!-- 댓글 생성용 -->
	<insert id="commuCommentInsert" parameterType="Map">
		INSERT INTO commucomment VALUES (SEQ_REP.NEXTVAL,#{id},#{lno},#{reply},DEFAULT)
	</insert>
	
	<!-- 댓글 생성용_Rcount컬럼 +1 -->
	<update id="commuRcPlusUpdate" parameterType="Map">
		UPDATE community SET rcount=rcount+1 WHERE lno=#{lno}
	</update>
	
	<!-- 댓글 수정용 -->
	<update id="commuCommentUpdate" parameterType="Map">
		UPDATE commucomment SET reply=#{reply} WHERE cno=#{cno}
	</update>
	
	<!-- 댓글 삭제용 -->
	<delete id="commuCommentDelete" parameterType="Map">
		DELETE FROM commucomment WHERE cno=#{cno}
	</delete>
	
	<!-- 댓글 삭제용_Rcount컬럼 -1 -->
	<update id="commuRcMinusUpdate" parameterType="Map">
		UPDATE community SET rcount=rcount-1 WHERE lno=#{lno}
	</update>
	
	<!-- 글 좋아요 -->
	<select id="commuLikeSelect" parameterType="Map" resultType="int">
		SELECT count(*) from likeboard WHERE id=#{id}
	</select>
	
	<!-- 글 좋아요_insert(likeboard테이블) -->
	<insert id="commuLikeInsert" parameterType="Map">
		INSERT INTO likeboard VALUES (#{id},#{lno})
	</insert>
	
	<!-- 글 좋아요_update(community테이블의 likecount+1) -->
	<update id="commuLikePlusUpdate" parameterType="Map">
		UPDATE community SET likecount=likecount+1 WHERE lno=#{lno}
	</update>
	
	<!-- 글 좋아요취소_delete(likeboard테이블) -->
	<delete id="commuLikeDelete" parameterType="Map">
		DELETE FROM likeboard WHERE id=#{id} AND lno=#{lno}
	</delete>
	
	<!-- 글 좋아요_update(community테이블의 likecount-1) -->
	<update id="commuLikeMinusUpdate" parameterType="Map">
		UPDATE community SET likecount=likecount-1 WHERE lno=#{lno}
	</update>
	
	
</mapper>